{% extends 'base.html' %}

{% block title %}ダッシュボード - {{ username }}{% endblock title %}

{% block content %}
<section class="section">
  <div class="container">
    <h1 class="title">
      <span class="icon">
        <i class="fas fa-tachometer-alt"></i>
      </span>
      ダッシュボード
    </h1>
    
    <!-- 統計カード -->
    <div class="columns">
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="title is-1 has-text-info">{{ total_todos }}</p>
          <p class="subtitle">総Todo数</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="title is-1 has-text-success">{{ completed_todos }}</p>
          <p class="subtitle">完了済み</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="title is-1 has-text-warning">{{ pending_todos }}</p>
          <p class="subtitle">未完了</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered">
          <p class="title is-1 has-text-danger">{{ priority_stats.high }}</p>
          <p class="subtitle">高優先度</p>
        </div>
      </div>
    </div>
    
    <!-- アクションとフィルター -->
    <div class="box">
      <div class="level">
        <div class="level-left">
          <div class="level-item">
            <a href="{{ reverse(master, 'todo:todo_create', username=username) }}" class="button is-primary">
              <span class="icon">
                <i class="fas fa-plus"></i>
              </span>
              <span>新しいTodo</span>
            </a>
          </div>
          <div class="level-item">
            <a href="{{ reverse(master, 'todo:category_list', username=username) }}" class="button is-link">
              <span class="icon">
                <i class="fas fa-tags"></i>
              </span>
              <span>カテゴリー管理</span>
            </a>
          </div>
          <div class="level-item">
            <a href="{{ reverse(master, 'accounts:change_password') }}" class="button is-warning">
              <span class="icon">
                <i class="fas fa-key"></i>
              </span>
              <span>パスワード変更</span>
            </a>
          </div>
        </div>
      </div>
      
      <!-- フィルター -->
      <form method="get">
        <div class="field is-grouped">
          <div class="control">
            <div class="select">
              <select name="status">
                <option value="all" {% if filter_status == 'all' %}selected{% endif %}>すべて</option>
                <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>未完了</option>
                <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>完了済み</option>
              </select>
            </div>
          </div>
          <div class="control">
            <div class="select">
              <select name="priority">
                <option value="all" {% if filter_priority == 'all' %}selected{% endif %}>すべての優先度</option>
                <option value="high" {% if filter_priority == 'high' %}selected{% endif %}>高</option>
                <option value="medium" {% if filter_priority == 'medium' %}selected{% endif %}>中</option>
                <option value="low" {% if filter_priority == 'low' %}selected{% endif %}>低</option>
              </select>
            </div>
          </div>
          <div class="control">
            <div class="select">
              <select name="category">
                <option value="all" {% if filter_category == 'all' %}selected{% endif %}>すべてのカテゴリー</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if filter_category == category.id %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="control">
            <button type="submit" class="button is-info">フィルター</button>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Todo一覧 -->
    {% if todos %}
    <div class="box">
      {% for todo in todos %}
      <div class="card mb-4">
        <div class="card-content">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <div>
                  <div class="todo-title {% if todo.completed %}is-completed{% endif %}">
                    {% if todo.completed %}
                      <span class="icon has-text-success">
                        <i class="fas fa-check"></i>
                      </span>
                    {% endif %}
                    <span class="todo-title-text">{{ todo.title }}</span>
                  </div>
                  {% if todo.description %}
                  <p class="subtitle is-6 {% if todo.completed %}has-text-grey-light{% endif %}">{{ todo.description }}</p>
                  {% endif %}
                  <div class="tags">
                    {% if todo.priority == 'high' %}
                      <span class="tag is-danger">高優先度</span>
                    {% elif todo.priority == 'medium' %}
                      <span class="tag is-warning">中優先度</span>
                    {% else %}
                      <span class="tag is-info">低優先度</span>
                    {% endif %}
                    
                    {% if todo.completed %}
                      <span class="tag is-success">完了</span>
                    {% else %}
                      <span class="tag is-light">未完了</span>
                    {% endif %}
                    
                    {% for category in categories %}
                      {% if category.id == todo.category_id %}
                        <span class="tag is-{{ category.color }}">{{ category.name }}</span>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <div class="buttons">
                  <a href="{{ reverse(master, 'todo:todo_toggle', username=username, todo_id=todo.id) }}" 
                     class="button is-small {% if todo.completed %}is-warning{% else %}is-success{% endif %}">
                    {% if todo.completed %}
                      <span class="icon">
                        <i class="fas fa-undo"></i>
                      </span>
                    {% else %}
                      <span class="icon">
                        <i class="fas fa-check"></i>
                      </span>
                    {% endif %}
                  </a>
                  <a href="{{ reverse(master, 'todo:todo_edit', username=username, todo_id=todo.id) }}" 
                     class="button is-small is-info">
                    <span class="icon">
                      <i class="fas fa-edit"></i>
                    </span>
                  </a>
                  <a href="{{ reverse(master, 'todo:todo_delete', username=username, todo_id=todo.id) }}" 
                     class="button is-small is-danger"
                     onclick="return confirm('このTodoを削除しますか？')">
                    <span class="icon">
                      <i class="fas fa-trash"></i>
                    </span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="box has-text-centered">
      <p class="title is-4 has-text-grey-light">Todoがありません</p>
      <p class="subtitle is-6 has-text-grey-light">新しいTodoを作成してみましょう</p>
      <a href="{{ reverse(master, 'todo:todo_create', username=username) }}" class="button is-primary">
        <span class="icon">
          <i class="fas fa-plus"></i>
        </span>
        <span>最初のTodoを作成</span>
      </a>
    </div>
    {% endif %}
  </div>
</section>
{% endblock content %}